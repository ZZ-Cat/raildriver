@name RailDriver
@model models/beer/wiremod/gate_e2_nano.mdl
# Advanced Duplicator properties
@persist [Dupe_state Dupe_loading_tick_interval E2_runtime_state]
@strict

if (duped())
{
    Dupe_state = 1
    Dupe_loading_tick_interval = tickInterval() * 1000
    E2_runtime_state = 0
    timer("dupe load watchdog", Dupe_loading_tick_interval)
}
elseif (dupefinished())
{
    Dupe_state = 2
    E2_runtime_state = 0
}
elseif (clk("dupe load watchdog"))
{
    stoptimer("dupe load watchdog")
    
    if (Dupe_state == 1)
    {
        # Dupe is still loading. Restart the watchdog timer.
        timer("dupe load watchdog", Dupe_loading_tick_interval)
    }
    elseif (Dupe_state == 2)
    {
        # Dupe has finished loading.
        # Reset the E2 and start the main script.
        reset()
    }
    else
    {
        # Error: E2 failed to load.
        Dupe_state = 0
        E2_runtime_state = 0
        printColor(vec(255, 0, 0), "[RailDriver | FATAL ERROR]", vec(255), ": E2 script could not be loaded.")
        exit()
    }
}
elseif (first())
{
    # E2 script loaded successfully.
    # Execute main runtime state machine.
    E2_runtime_state = 1
}

event tick()
{
    if (E2_runtime_state == 1)
    {
        # Start main script.
        E2_runtime_state = 2

        # Print Welcome Message.
        printColor(vec(255), "Welcome to RailDriver.")
    }
    elseif (E2_runtime_state == 2)
    {
        # Run main script.
    }
    else
    {
        # E2 core state machine is in an unknown state.
        E2_runtime_state = 0
        printColor(vec(255, 0, 0), "[RailDriver | FATAL ERROR]", vec(255), ": E2 runtime terminated with unknown state.")
        exit()
    }
}
